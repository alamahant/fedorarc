#!/bin/bash
# select_init - switch between OpenRC and systemd symlink configurations
# Usage: select_init openrc | systemd | status

set -e

show_status() {
    echo "Current symlink status:"
    echo "  /sbin/init -> $(readlink -f /sbin/init 2>/dev/null || echo 'missing')"
    echo "  /etc/dnf/dnf.conf -> $(readlink -f /etc/dnf/dnf.conf 2>/dev/null || echo 'missing')"
    echo "  /etc/default/grub -> $(readlink -f /etc/default/grub 2>/dev/null || echo 'missing')"
    echo "  /etc/dracut.conf.d/fedora.conf -> $(readlink -f /etc/dracut.conf.d/fedora.conf 2>/dev/null || echo 'missing')"
    echo "  /usr/lib/tmpfiles.d -> $(readlink -f /usr/lib/tmpfiles.d 2>/dev/null || echo 'missing')"
    echo "  /usr/lib/udev/rules.d -> $(readlink -f /usr/lib/udev/rules.d 2>/dev/null || echo 'missing')"
}

switch_openrc() {
    echo "[*] Switching to OpenRC configuration..."
    ln -sf /usr/sbin/openrc-init /sbin/init
    mv /lib/systemd/systemd /lib/systemd/no-systemd || true
    ln -sf /etc/dnf/dnf-openrc /etc/dnf/dnf.conf
    ln -sf /etc/default/grub-openrc /etc/default/grub
    ln -sf /etc/dracut.conf.d/dracut-openrc.conf /etc/dracut.conf.d/fedora.conf

    rm -f /usr/lib/tmpfiles.d
    ln -s /usr/lib/tmpfiles-openrc/ /usr/lib/tmpfiles.d

    rm /usr/lib/udev/rules.d
    ln -s /usr/lib/udev/openrc-rules/ /usr/lib/udev/rules.d

    update_boot


    sed -i 's/#alias poweroff/#lias poweroff/g' /etc/bash/bashrc.d/myaliases.bash
    sed -i 's/#alias reboot/alias reboot/g' /etc/bash/bashrc.d/myaliases.bash

    echo "[+] Switched to OpenRC."
    echo "IMPORTANT: PLEASE RUN 'source /etc/profile' AND 'systemctl poweroff/restart' TO SHUTDOWN THE MACHINE JUST ONCE THIS TIME"
}

switch_systemd() {
    echo "[*] Switching to systemd configuration..."
    if [ -f /lib/systemd/no-systemd ]; then
    mv /lib/systemd/no-systemd /lib/systemd/systemd 
    fi

    ln -sf /lib/systemd/systemd /sbin/init

    ln -sf /etc/dnf/dnf-systemd /etc/dnf/dnf.conf
    ln -sf /etc/default/grub-systemd /etc/default/grub
    ln -sf /etc/dracut.conf.d/dracut-systemd.conf /etc/dracut.conf.d/fedora.conf

    rm -f /usr/lib/tmpfiles.d
    ln -s /usr/lib/tmpfiles-systemd/ /usr/lib/tmpfiles.d

    rm /usr/lib/udev/rules.d
    ln -s /usr/lib/udev/systemd-rules/ /usr/lib/udev/rules.d

    update_boot

    sed -i 's/alias poweroff/#alias poweroff/g' /etc/bash/bashrc.d/myaliases.bash
    sed -i 's/alias reboot/#alias reboot/g' /etc/bash/bashrc.d/myaliases.bash

    echo "[+] Switched to systemd."
echo "IMPORTANT: PLEASE RUN source /etc/profile AND 'openrc-shutdown -p/-r now' TO SHUTDOWN THE MACHINE JUST ONCE THIS TIME"
}

update_boot() {
grub2-mkconfig -o /boot/grub2/grub.cfg
dracut /boot/initramfs-$(ls /lib/modules | head -n1).img --kver $(ls /lib/modules | head -n1) --force
}

case "$1" in
    openrc)
        switch_openrc
        ;;
    systemd)
        switch_systemd
        ;;
    status)
        show_status
        ;;
    *)
        echo "Usage: $0 {openrc|systemd|status}"
        exit 1
        ;;
esac