#!/bin/bash

systemctl stop systemd-udevd || true
rc-service udev stop || true

# Remove the entire udev database and cache
rm -rf /var/run/udev/
rm -rf /run/udev/
rm -f /etc/udev/hwdb.bin
rm -f /lib/udev/hwdb.bin

# Remove persistent rules and links
rm -rf /dev/.udev/
rm -f /etc/udev/rules.d/*.rules~

# Recreate directories
mkdir -p /var/run/udev
mkdir -p /run/udev
mkdir -p /dev/.udev

# Reload hardware database
udevadm hwdb --update

# Trigger hardware re-scan
udevadm trigger --type=subsystems --action=add
udevadm trigger --type=devices --action=add

# Settle udev events
udevadm settle --timeout=30

# Restart udev service
rc-service udev start || true
systemctl start systemd-udevd || true